# Общий обзор протокола

В работе протокола существует два основных режима работы: “ведущий” и
“гость”. Режим работы “ведущий” отводится единственному инстансу
моделирования (который может быть реализован как в рамках рабочего
инстанса, так в виде отдельного процесса), который отвечает за
коммуникацию между “гостями”. Режим работы “гость” отводится всем прочим
инстансам моделирования.

Первым запущенным процессом должен быть ведущий. Гости подключаются к
ведущему. При подключении к ведущему, гость согласует метод коммуникации
(напр., сокеты, разделяемая память, fifo, etc) и версию протокола.
Первичное подключение осуществляется по протоколу TCP/IP.

## Инициализация

1.  Используя согласованный метод коммуникации, гость сообщает свое
    название, опционально целевое время симуляции, а также список
    импортируемых параметров. Список импортируемых параметров должен
    содержать название инстанса, который должен экспортировать эти
    параметры, полные названия параметров, тип и их длину.

2.  Ведущий ожидает ввода пользователя о том, что все гости запущены и
    подключены

3.  Ведущий производит согласование параметров, сообщая гостям о
    запрошенных у них другими гостями параметрах и текущее время
    симуляции (может быть отлично от нуля, см.
    \[subsec:=00041F=00043E=000434=00043A=00043B=00044E=000447=000435=00043D=000438=000435-=00043F=000440=000438-=000432=00044B=00043F=00043E=00043B=00043D=000435=00043D=000438=000438\])

4.  Если гость не может экспортировать требуемые параметры, он сообщает
    об этом ведущему, а ведущий в свою очередь пользователю, и
    выполнение завершается. Иначе, гость сообщает ведущему текущие (т.е.
    начальные, либо см.
    \[subsec:=00041F=00043E=000434=00043A=00043B=00044E=000447=000435=00043D=000438=000435-=00043F=000440=000438-=000432=00044B=00043F=00043E=00043B=00043D=000435=00043D=000438=000438\])
    значения запрошенных
    параметров.\[enu:=000415=000441=00043B=000438-=000433=00043E=000441=000442=00044C-=00043D=000435\]

5.  По мере получения, ведущий передает начальные значения параметров
    запросившим их гостям.

6.  Гости могут произвести локальную инициализацию на основе полученных
    значений.

7.  Инициализация завершена. Запускается основной цикл.

## Основной цикл

1.  Когда гость завершает очередной шаг моделирования (или
    инициализацию) и находится на временном шаге $t_{i}$, он должен
    оценить размер своего следующего шага $\Delta t$.

2.  Затем гость отправляет ведущему свою оценку необходимого шага
    $\Delta t$.
    \[enu:=000417=000430=000442=000435=00043C-=000433=00043E=000441=000442=00044C-=00043E=000442=00043F=000440=000430=000432=00043B=00044F=000435=000442\]

3.  Получив все оценки шагов от гостей, ведущий выбирает наименьший
    $\Delta t_{min}$ и рассылает гостям это
    значение.\[enu:=00041F=00043E=00043B=000443=000447=000438=000432-=000432=000441=000435-=00043E=000446=000435=00043D=00043A=000438\]

4.  Гости должны совершить шаг, соответствующий полученному значению
    $\Delta t_{min}$, либо интерполировать полученные результаты для
    момента времени $t=t_{i}+\Delta t_{min}$

5.  Каждый из гостей передает ведущему рассчитанные значения параметров,
    полученные в результате этого шага (либо сообщение о завершении
    шага, если передача параметров не
    требуется)\[enu:=00041A=000430=000436=000434=00044B=000439-=000438=000437-=000433=00043E=000441=000442=000435=000439\]

6.  Ведущий, получив значения рассчитанных параметров для момента
    времени $t=t_{i}+\Delta t_{min}$, передает эти данные запросившим их
    на этапе инициализации
    гостям.\[enu:=000412=000435=000434=000443=000449=000438=000439,-=00043F=00043E=00043B=000443=000447=000438=000432-=000437=00043D=000430=000447=000435=00043D=000438=00044F\]

7.  Если целевое время симуляции достигнуто, завершить цикл. Иначе,
    перейти к (1).

## Терминация

Если гость не может продолжать выполнение симуляции, он должен сообщить
об этом, на очередном шаге моделирования передав сигнал аварийной
остановки и текстовое сообщение о возникшей проблеме вместо шага
\[enu:=000417=000430=000442=000435=00043C-=000433=00043E=000441=000442=00044C-=00043E=000442=00043F=000440=000430=000432=00043B=00044F=000435=000442\]
или
\[enu:=00041A=000430=000436=000434=00044B=000439-=000438=000437-=000433=00043E=000441=000442=000435=000439\]
основного цикла. После этого ведущий сообщает пользователю о возникшей
проблеме и приостанавливает симуляцию.

Если гость “завис” либо был аварийно завершен без возможности передачи
сообщения об этом, ведущий остановится на шаге
\[enu:=00041A=000430=000436=000434=00044B=000439-=000438=000437-=000433=00043E=000441=000442=000435=000439\]
основного цикла. Пользователь может сообщить ведущему, что гость более
недоступен и приостановить симуляцию вручную.

Если ведущий решает остановить симуляцию (по запросу пользователя или по
достижению целевого времени симуляции), на шаге
\[enu:=00041F=00043E=00043B=000443=000447=000438=000432-=000432=000441=000435-=00043E=000446=000435=00043D=00043A=000438\]
или
\[enu:=000412=000435=000434=000443=000449=000438=000439,-=00043F=00043E=00043B=000443=000447=000438=000432-=000437=00043D=000430=000447=000435=00043D=000438=00044F\]
основного цикла, ведущий, вместо целевого шага $\Delta t_{min}$,
передает гостям сигнал завершения работы. Гость должен завершить
соединение с ведущим и далее может производить необходимые для локальной
терминации действия. Когда все гости завершены, ведущий освобождает
временные буферы и завершает работу.

## Подключение при выполнении\[subsec:=00041F=00043E=000434=00043A=00043B=00044E=000447=000435=00043D=000438=000435-=00043F=000440=000438-=000432=00044B=00043F=00043E=00043B=00043D=000435=00043D=000438=000438\]

Если гость аварийно завершил работу, ведущий приостанавливает симуляцию.
Однако, если данный гость будет перезапущен, симуляция может быть
продолжена. Процесс подключения при выполнении аналогичен процессу
инициализации, однако гостю передаются текущие значения параметров,
необходимых ему для инициализации. Любые временные буферы,
использовавшиеся ведущим до аварийного завершения гостя, очищаются и
повторно используются для вновь подключившегося гостя. Следует иметь
ввиду, что, поскольку ведущий может не знать значений внутренних
параметров, необходимых для работы гостя, вновь подключившийся гость
должен самостоятельно позаботиться о том, чтобы сохранять и
восстанавливать их.

# Подробное описание протокола

Сообщения кодируются при помощи Google Protocol Buffers. В связи с этим,
описание формата сообщений представлено на языке proto.

Рекомендуемый размер буфера для сообщения 80 КиБ (81920 байт). Это
соответствует возможности передать в одном сообщении 8191 параметров
типа double (8+2 байт на параметр+1 байт на сообщение). Если этого
недостаточно, возможна передача сообщения в несколько кусков. Ведущий
должен определять, когда все параметры переданы (простым подсчетом) и
ожидать новых сообщений до этого момента.

## Сообщение первичного подключения

    enum LinkType {
        TCP = 0;
        SHMEM = 1;
        FIFO = 2;
    }

    message NewConnectionRequest {
        required uint32 protocolVersion = 1;
        optional LinkType suggestedLinkType = 2;
        extensions 100 to max;
    }

    message NewConnectionReply {
        enum Status {
            OK = 0;
            ERROR = 1;
        }
        required Status result = 1;
        required LinkType useLinkType = 2;
        optional TCPConnParams tcpConnParams = 3;
        optional SHMEMConnParams shmemConnParams = 4;
        optional FIFOConnParams fifoConnParams = 5;
        optional string message = 99; //Only meaningful when result=ERROR
        extensions 100 to max;
    }

    message TCPConnParams {
        required string address = 1;
        required uint32 port = 2;
    }

    message SHMEMConnParams {
        required string name = 1;
    }

    message FIFOConnParams {
        required string nameIn = 1;
        required string nameOut = 2;
    }

Поля расширения используются для согласования поддерживаемых гостем и
ведущим расширений протокола (описано далее). Только одно из
опциональных полей [\*]{}ConnParams установлено, в зависимости от
значения useLinkType.

Для использования FIFO требуется создание двух именованных пайпов.
NameIn должен быть открыт гостем для чтения, nameOut для записи.

## Сообщение инициализации

    message Init {
        required string name = 1; //Name of instance
        optional double targetTime = 2; //Target simulation time
        repeated InstanceImports imports = 3;
    }

    message InstanceImports {
        required string name = 1;
        repeated ParamImports params = 2;
    }

    message ParamImports {
        required string name = 1;
        enum ParamType {
            PT_DOUBLE = 0;
            PT_INT = 1;
            PT_FLOAT = 2;
        }
        optional ParamType type = 2 [default=PT_DOUBLE];
        optional int32 length = 3 [default=1];
    }

## Сообщение запроса экспортируемых параметров

    message ExportParametersRequest {
        optional double simulationTime = 1 [default=0];
        repeated ParamImports exports = 2;
    }

## Сообщение передачи величин экспортируемых параметров

    message ParameterValue {
        optional double doubleValue = 1;
        optional sint32 intValue = 2;
        optional float floatValue = 3;
    }
    message ParameterValues {
        repeated ParameterValue values=1;
    }

Значения должны быть представлены в том же порядке, что и названия в
ExportParametersRequest при передачи ведущему, и в том же порядке, что и
названия в Init при передаче гостю.

## Сообщение оценки/величины следующего шага

    message StepValue {
        required double step = 1;
    }

## Сообщение ошибки гостя, остановки симуляции или завершения соединения

    message Termination {
        enum Type {
            TERM_EXIT=0; //Connection close OR simulation finished
            TERM_ERROR=1; //Guest error OR simulation halted
        }
        required Type type = 1;
        optional string message = 2; //If type==TERM_ERROR, should be set
    }

## Общий формат сообщения начиная с шага \[enu:=000415=000441=00043B=000438-=000433=00043E=000441=000442=00044C-=00043D=000435\] инициализации

    message GeneralMessage {
        optional Termination msg = 1;
        optional ParameterValues values = 2;
        optional StepValue step = 3;
    }
